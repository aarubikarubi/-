import pystray
from PIL import Image, ImageDraw
import threading
import time
import sys
import os
import urllib.parse
import webbrowser
import traceback
from PyQt6.QtWidgets import QApplication, QMessageBox

# src/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.insert(0, os.path.join(os.path.dirname(os.path.abspath(__file__)), "src"))

from core import GameMonitor, State
import setup_ui
import keyboard
import update_manager

def create_image():
    # ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç·‘è‰²ã®å››è§’å½¢ï¼‰ã‚’ç”Ÿæˆ
    image = Image.new('RGB', (64, 64), color=(30, 30, 30))
    d = ImageDraw.Draw(image)
    d.rectangle(
        [(16, 16), (48, 48)],
        fill=(100, 200, 100)
    )
    return image

def update_menu(icon, monitor):
    # ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‹•çš„ã«æ›´æ–°ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    status = monitor.get_status_text()
    if monitor.waiting_for_launch:
        status += " (èµ·å‹•å¾…æ©Ÿä¸­...)"
    
    menu = pystray.Menu(
        pystray.MenuItem("ç¾åœ¨ã®çŠ¶æ…‹: ", lambda: None, enabled=False),
        pystray.MenuItem(lambda text: monitor.get_status_text(), lambda: None, enabled=False),
        pystray.Menu.SEPARATOR,
        pystray.MenuItem("â–¶ æ—¥èª²ã‚’é–‹å§‹", lambda: action_start_routine(icon, monitor)),
        pystray.MenuItem("â­ æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸å¼·åˆ¶ã‚¹ã‚­ãƒƒãƒ—", lambda: action_skip(icon, monitor)),
        pystray.MenuItem("è¨­å®šç”»é¢ã‚’é–‹ã", lambda: action_settings()),
        pystray.MenuItem("ğŸ’¡ è¦æœ›ãƒ»ãƒã‚°å ±å‘Šã‚’é€ã‚‹", lambda: action_open_feedback()),
        pystray.MenuItem("ãƒªã‚»ãƒƒãƒˆ (å¾…æ©Ÿã«æˆ»ã™)", lambda: action_reset(icon, monitor)),
        pystray.Menu.SEPARATOR,
        pystray.MenuItem("å®Œå…¨ã«çµ‚äº†", lambda: action_exit(icon, monitor))
    )
    icon.menu = menu

def action_skip(icon, monitor):
    monitor.skip_current()
    update_icon_menu(icon, monitor)

def action_start_routine(icon, monitor):
    if monitor.games:
        monitor.start_specific_game(0, chain_launch=True)
        update_icon_menu(icon, monitor)

def update_icon_menu(icon, monitor):
    update_menu(icon, monitor)

def action_reset(icon, monitor):
    monitor.reset_state()
    update_icon_menu(icon, monitor)

def action_settings():
    if 'app' in globals() and app:
        app.safe_show()

def action_open_feedback():
    base_url = "https://github.com/aarubikarubi/DailyGameLauncher/issues/new"
    params = {
        "title": "ã€è¦æœ›ãƒ»å ±å‘Šã€‘",
        "body": "ã“ã“ã«æ©Ÿèƒ½ã®è¦æœ›ã‚„ãƒã‚°å ±å‘Šã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚\n\n---\nç’°å¢ƒæƒ…å ±:\nOS: Windows\n",
        "labels": "enhancement"
    }
    url = f"{base_url}?{urllib.parse.urlencode(params)}"
    webbrowser.open(url)

def action_exit(icon, monitor):
    monitor.stop()
    icon.stop()
    if 'app' in globals() and app:
        app.safe_quit()

def global_exception_handler(exctype, value, tb):
    # ã‚¨ãƒ©ãƒ¼å†…å®¹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    err_msg = "".join(traceback.format_exception(exctype, value, tb))
    print("Uncaught Exception:", err_msg, file=sys.stderr)

    # QApplicationã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãªã„å ´åˆã¯ä½œæˆ
    qapp = QApplication.instance()
    if not qapp:
        qapp = QApplication(sys.argv)

    # ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤º
    msg_box = QMessageBox()
    msg_box.setIcon(QMessageBox.Icon.Critical)
    msg_box.setWindowTitle("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼")
    msg_box.setText("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\né–‹ç™ºè€…ã«å ±å‘Šã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’æ”¹å–„ã—ã¾ã™ã‹ï¼Ÿ")
    msg_box.setDetailedText(err_msg)
    
    report_btn = msg_box.addButton("å ±å‘Šã™ã‚‹ (ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã)", QMessageBox.ButtonRole.AcceptRole)
    ignore_btn = msg_box.addButton("ç„¡è¦–ã—ã¦é–‰ã˜ã‚‹", QMessageBox.ButtonRole.RejectRole)
    
    msg_box.exec()

    if msg_box.clickedButton() == report_btn:
        base_url = "https://github.com/aarubikarubi/DailyGameLauncher/issues/new"
        params = {
            "title": f"[ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒ¬ãƒãƒ¼ãƒˆ] {exctype.__name__}",
            "body": f"ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n```python\n{err_msg}\n```\n\n---\nè¿½åŠ ã®æƒ…å ±ãŒã‚ã‚Œã°ã“ã“ã«è¨˜è¼‰ã—ã¦ãã ã•ã„:",
            "labels": "bug"
        }
        url = f"{base_url}?{urllib.parse.urlencode(params)}"
        webbrowser.open(url)

def monitor_state_changes(icon, monitor):
    # çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨è¨˜ã‚’æ›´æ–°ã™ã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯
    last_state = monitor.state
    last_waiting = monitor.waiting_for_launch
    last_games_count = len(monitor.games)
    
    while monitor._running:
        current_count = len(monitor.games)
        if last_state != monitor.state or last_waiting != monitor.waiting_for_launch or last_games_count != current_count:
            last_state = monitor.state
            last_waiting = monitor.waiting_for_launch
            last_games_count = current_count
            update_icon_menu(icon, monitor)
        time.sleep(1)

if __name__ == "__main__":
    # ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
    sys.excepthook = global_exception_handler

    base_dir = os.path.dirname(os.path.abspath(__file__))
    config_path = os.path.join(base_dir, "config.json")
    
    monitor = GameMonitor(config_path=config_path)
    monitor.start()
    
    def on_settings_close():
        monitor.load_config()
        monitor.reset_state()
        if 'icon' in globals():
            update_icon_menu(icon, monitor)
            
    # GUIã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ä½œæˆ
    app = setup_ui.GameSetupApp(config_path, on_close_callback=on_settings_close, monitor=monitor)
    
    # èµ·å‹•æ™‚ã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç¢ºèª
    update_manager.check_and_apply_updates(app.window)
    
    # ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®è¡¨ç¤ºè¨­å®šã‚’é©ç”¨
    if "--startup" in sys.argv:
        app.withdraw()
        if app.window.show_on_startup:
            app.safe_show()
    else:
        if app.window.show_on_startup:
            app.safe_show()
        else:
            app.withdraw()
        
    icon_path = os.path.join(base_dir, "assets", "icon.ico")
    icon = pystray.Icon("DailyChainLauncher", create_image(), "æ—¥èª²ãƒ„ãƒ¼ãƒ«")
    update_menu(icon, monitor)
    
    # ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰
    update_thread = threading.Thread(target=monitor_state_changes, args=(icon, monitor), daemon=True)
    update_thread.start()
    
    # æ—¥èª²å®Œäº†æ™‚ã®è‡ªå‹•çµ‚äº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
    monitor.on_completion_callback = lambda: action_exit(icon, monitor)
    
    # ã‚¿ã‚¹ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
    icon_thread = threading.Thread(target=icon.run, daemon=True)
    icon_thread.start()
    
    # ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã®ç™»éŒ²
    try:
        keyboard.add_hotkey('ctrl+shift+s', lambda: action_skip(icon, monitor))
    except Exception as e:
        print(f"Failed to register hotkey: {e}")
    
    # PyQt6ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
    app.mainloop()
    
    # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œã€å¿µã®ãŸã‚ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾
    monitor.stop()
    if 'icon' in globals():
        icon.stop()
